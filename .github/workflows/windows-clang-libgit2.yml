name: Build libgit2 with Clang (Windows)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    # Setting the default shell to bash for all steps in this job
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: 'Silverlan/test_libgit2'

      - name: Download and Extract LLVM
        run: |
          echo "Downloading LLVM 21.1.8..."
          curl -L -o llvm.tar.xz https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.8/clang+llvm-21.1.8-x86_64-pc-windows-msvc.tar.xz
          
          echo "Extracting LLVM..."
          # tar in Git Bash handles .tar.xz
          tar -xf llvm.tar.xz
          
          # Move to a simpler path to avoid space issues and long path names
          mv clang+llvm-21.1.8-x86_64-pc-windows-msvc llvm_dist

      - name: Configure and Build libgit2
        run: |
          # Define absolute paths for the compilers
          # We use the full path to clang.exe/clang++.exe to avoid clang-cl defaults
          LLVM_PATH=$(pwd)/llvm_dist/bin
          export CC="$LLVM_PATH/clang.exe"
          export CXX="$LLVM_PATH/clang++.exe"
          
          echo "Using Compiler: $CC"
          
          mkdir build
          cd build
          
          # Using Ninja as it is the most reliable generator for Clang on Windows
          # -DUSE_SSH=OFF and -DENABLE_TRACE=ON are common libgit2 flags
          cmake .. \
            -G "Ninja" \
            -DCMAKE_C_COMPILER="$CC" \
            -DCMAKE_CXX_COMPILER="$CXX" \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON
          
          cmake --build . --config Release

      - name: Verify Build
        run: |
          ls -R build/*.dll build/*.lib || echo "Build artifacts not found where expected"
