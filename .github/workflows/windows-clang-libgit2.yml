name: Build libgit2 with Clang (Windows)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    # Force all run steps to use Bash instead of PowerShell
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout libgit2
        uses: actions/checkout@v4
        with:
          repository: libgit2/libgit2
          path: libgit2

      - name: Download and Extract LLVM
        run: |
          echo "Downloading LLVM..."
          curl -L -o llvm.tar.xz https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.8/clang+llvm-21.1.8-x86_64-pc-windows-msvc.tar.xz
          
          echo "Extracting LLVM..."
          mkdir -p llvm_install
          # -C changes to the directory, --strip-components-1 removes the top-level folder from the archive
          tar -xf llvm.tar.xz -C llvm_install --strip-components=1
          
          # Add Clang to the path for this session
          echo "$(pwd)/llvm_install/bin" >> $GITHUB_PATH

      - name: Configure and Build libgit2
        run: |
          cd libgit2
          mkdir build && cd build
          
          # We explicitly point to clang.exe (the driver) rather than clang-cl
          # Using Ninja generator is recommended for Clang on Windows
          cmake .. \
            -G "Ninja" \
            -DCMAKE_C_COMPILER="$(pwd)/../../llvm_install/bin/clang.exe" \
            -DCMAKE_CXX_COMPILER="$(pwd)/../../llvm_install/bin/clang++.exe" \
            -DCMAKE_BUILD_TYPE=Release
            
          cmake --build .
